<html>
    <head>
        {% load staticfiles %}
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
        <link rel="stylesheet" href="/static/main.css">
        <script type='text/javascript' src="{% static 'js/jquery-1.12.3.min.js' %}"></script>
        <script type='text/javascript' src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
        <script type='text/javascript' src="{% static 'js/typeahead.bundle.min.js' %}"></script>
        <script type='text/javascript' src="{% static 'js/jquery.js' %}"></script>
        <script src="http://d3js.org/d3.v3.min.js"></script>
        <script>
            {% block content %}
            $.ajax({
                type: "GET",
                url: "/",
                contentType: "application/json",
                dataType: "json",
                data: {
                    search: "{{ search_params }}",
                    page: "{{ page_params }}"
                },
                success: function(response) {
                    if ("{{ search_params }}"!="") {
                        if (response[0].length != 3) {
                            document.getElementById("barchart").innerHTML = response[0]
                        }
                        else {
                            draw_d3(response);
                        }
                    }
                },
                error: function(response) {
                    console.log("error");
                }
            });
            {% endblock %}
            
            //function that draws star according to ratings
    function drawStars(num){
      full_star = '<img src="{% static 'star1.png' %}">'
      half_star = '<img src="{% static 'star_half.png' %}">'
      if (num === parseInt(num, 10))
        return repeat(full_star,num)
      else
        inte = parseInt(num)
        return repeat(full_star,inte) + half_star
    }

    //helper code taken from stackoverflow
    function repeat(pattern, count) {
    if (count < 1) return '';
    var result = '';
    while (count > 1) {
        if (count & 1) result += pattern;
        count >>= 1, pattern += pattern;
    }
    return result + pattern;
    }

    //function that draws the d3

    function draw_d3(data_updated){

         var chartWidth       = 300,
             barHeight        = 20,
             groupHeight      = barHeight,
             gapBetweenGroups = 10,
             spaceForLabels   = 200,
             spaceForLegend   = 150;

          // Zip the series data together (first values, second values, etc.)
        var zippedData = [];
        for (var i=0; i<data_updated.length; i++) {
            zippedData.push(data_updated[i][1]);
          }

        var labels = [];
        for (var i=0; i<data_updated.length; i++) {
            labels.push(data_updated[i][0]);
          }

        var specifics = [];
        for (var i=0; i<data_updated.length; i++) {
          specifics.push(data_updated[i][2]);
          }

        // Color scale
        var color = d3.scale.category20();
        var chartHeight = barHeight * zippedData.length + gapBetweenGroups * labels.length;

        var x = d3.scale.linear()
            .domain([0, d3.max(zippedData)])
            .range([0, chartWidth]);

        var y = d3.scale.linear()
            .range([chartHeight + gapBetweenGroups, 0]);

        var yAxis = d3.svg.axis()
            .scale(y)
            .tickFormat('')
            .tickSize(0)
            .orient("left");

        // Specify the chart area and dimensions
        var chart = d3.select(".chart")
            .attr("width", spaceForLabels + chartWidth + spaceForLegend)
            .attr("height", chartHeight);

        // Create bars
        var bar = chart.selectAll("g")
            .data(zippedData)
            .enter().append("g")
            .attr("transform", function(d, i) {
              return "translate(" + spaceForLabels + "," + (i * barHeight + gapBetweenGroups * (0.5 + Math.floor(i))) + ")";
            }));

        // Create rectangles of the correct width
        bar.append("rect")
            .attr("fill", function(d,i) { return color(i % 1); })
            .attr("class", "bar")
            .attr("width", x)
            .attr("height", barHeight - 1);


        // Add text label in bar
        bar.append("text")
            .attr("x", function(d) { return x(d) - 3; })
            .attr("y", barHeight / 2)
            .attr("fill", "red")
            .attr("dy", ".35em")
            .text(function(d) { return Math.round(d * 100) / 100; });

        // Draw labels
        bar.append("text")
            .attr("class", "label")
            .attr("x", function(d) { return - 10; })
            .attr("y", groupHeight / 2)
            .attr("dy", ".35em")
            .text(function(d,i) {
              if (i % 1 === 0)
                return labels[Math.floor(i)];
              else
                return ""});

        chart.append("g")
              .attr("class", "y axis")
              .attr("transform", "translate(" + spaceForLabels + ", " + -gapBetweenGroups/2 + ")")
              .call(yAxis);

    };
        </script>
    </head>
    
    <body>
        <div class="topcorner">
            <p>Beer Recommendation</p>
            <p>Ilan Filonenko: if56</p>
            <p>Kelsey Duncan: ked83</p>
            <p>Pujaa Rajan: pr3388</p>
            <p>Zheng Yao: zy87</p>
        </div>
        
        <form class="form-inline global-search" method='GET'>
            <h1 style="font-size: 55px; font-family:Futura; color: #4285F4">
                B
                <font color=#EA4335>E</font>
                <font color=#FBBC05>E</font>
                <font color=#34A853>R</font>
                <font color=#FBBC05>G</font>
                <font color=#34A853>L</font>
                <font color=#EA4335>E</font>
            </h1>
            
            <br><br>
            
            <div id="the-basics" class="form-group">
                <input id="input1" type="text" name="search" class="typeahead form-control" placeholder="Beer Name">
            </div>
            <div id="the-features" class="form-group">
                <input id="input2" type="text" name="search_features" class="typeahead form-control" placeholder="Beer Feature">
            </div>
            <button id="search-button" type="button" class="btn btn-info"> Go! </button>
        </form>
        <div class="container-multi" style="margin-left: 10.5em;">
            <ul id="choices" class="choices" style="list-style: none;"> 
            </ul>
        </div>
        <div class="output form-inline global-search">
            <h4>Output</h4>
            <br>
            Search values: {{search_params}}
            <br>
            Page Number: {{page_params}}
            <br>
            <div id="barchart">
                <svg class="chart"></svg>
            </div>
<!--             <div id="popout">
            </div> -->
        </div>
    </body>
</html>
